<!DOCTYPE html>
<html>
<head>
  <script src="jquery.min.js"></script>
  <title>picamera MJPEG streaming demo</title>
  <link rel="stylesheet" href="style.css">
</head>
<body background="MarsBackground.png">
  <div style="width:100%;">
    <div style="float: left;">
      <h1>Mars Rover Live Pictures</h1>
      <img hidden id="screen" src="stream.mjpg" width="640" height="480" />
      <img id="static" src="static.gif" width="640" height="480" />
      <h2 id="voltage">Waiting for battery voltage</h2>
    </div>
    <div style="float: left; margin-left: 20px;">
      <h1>Command Window</h1>
      <div>
        <div>
          <textarea cols="10" id="commands"></textarea>
        </div>
        <div id="response">Communuction Error. Cannot submit commands at this time<br /></div>
      </div>
      <h1>
        <button id="submit" type="button" onclick="submitCommands();" style="background-color: Orange;">Submit</button>
        <button type="button" onclick="clearCommands();">Clear</button>
      </h1>
    </div>
  </div>
<script>

var commsError = true;

var myVar = setInterval(function(){ getVoltage() }, 1000);

function getVoltage() {
    $.getJSON("/voltage/", function(jsonData){
        $("#voltage").html("Battery voltage: " + jsonData[0].value.toFixed(3) + " Volts");
        if(jsonData[0].value > 11) {
            $("#voltage").css("backgroundColor", "Green");
        } else if(jsonData[0].value > 10) {
            $("#voltage").css("backgroundColor", "Orange");
        } else {
            $("#voltage").css("backgroundColor", "Red");
        }
        if(commsError){ // comms restored but commsError is true so do this lot once
            $("#screen").show();
            $("#static").hide();
            $("#response").html("Type your commands in the window above and click Submit<br />");
            $("#commands").css("color", "Green");
            $("#submit").css("backgroundColor", "Green");
            $("#submit").css("color", "White");
        }
        commsError = false;
    })
    .fail(function() {
        commsError = true;
        $("#submit").css("backgroundColor", "Orange");
        $("#commands").css("color", "Red");
        $("#static").show();
        $("#screen").hide();
        $("#response").html("Communuction Error. Cannot submit commands at this time");
    });
}

function clearCommands() {
    document.getElementById("commands").value = "";
    document.getElementById("response").innerHTML = "Type your commands in the window above and click Submit<br />";
}

var commands = [];

function submitCommands() {
    if(commsError){
        return;
    }
    document.getElementById("response").innerHTML = "Type your commands in the window above and click Submit<br />";
    if(testCommands()) {
        executeCommands();
    }
}

var limit = 4; // <---max no of lines you want in textarea
var textarea = document.getElementById("commands");
var spaces = textarea.getAttribute("cols");

textarea.onkeyup = function() {
    var lines = textarea.value.split("\n");
    
    for (var i = 0; i < lines.length; i++)
    {
        if (lines[i].length <= spaces) continue;
        var j = 0;
        
        var space = spaces;

        while (j++ <= spaces)
        {
            if (lines[i].charAt(j) === " ") space = j;
        }
        lines[i + 1] = lines[i].substring(space + 1) + (lines[i + 1] || "");
        lines[i] = lines[i].substring(0, space);
    }
    if(lines.length>limit)
    {
        textarea.style.color = 'red';
        setTimeout(function(){
            if(commsError){
                textarea.style.color = 'red';
            } else {
                textarea.style.color = 'green';
            }
        },500);
    }
    textarea.value = lines.slice(0, limit).join("\n");
};

function testCommands() {
    var goodCommands = true;
    var lines = textarea.value.split("\n");
    var numLines = lines.length;
    if(numLines > 1 && lines[numLines-1].length === 0) {
        numLines--;  // ignore last command line if it is zero length
    }
    console.log(numLines);
    for(i = 0; i < numLines; i++) {
        if(lines[i].indexOf("forward ") === 0 || lines[i].indexOf("backward ") === 0 || lines[i].indexOf("left ") === 0 || lines[i].indexOf("right ") === 0) {
            commands[i] = lines[i].split(" ");
            if (isInt(commands[i][1])){
                if (commands[i][1] < 1 || commands[i][1] > 5) {
                    $("#response").append("Error line " + (i+1) + " value out of range (must be 1, 2, 3, 4 or 5)<br />")
                    goodCommands = false;
                }
            } else {
                $("#response").append("Error line " + (i+1) + " value is not an integer<br />")
                goodCommands = false;
            }
        } else {
            $("#response").append("Syntax error line " + (i+1) + "<br />")
            goodCommands = false;
        }
    }
    return(goodCommands);
}

function executeCommands(){
    var lines = textarea.value.split("\n");
    var numLines = lines.length;
    if(numLines > 1 && lines[numLines-1].length === 0) {
        numLines--; // ignore last command line if it is zero length
    }
    if(numLines > 0){
        $("#response").append("Executing commands<br />");
        $.ajax({url: commands[0][0] + "/" + commands[0][1] + "/", success: function(result){
            $("#response").append("Command line 1 " + result + "<br />");
            if(numLines > 1){
                $.ajax({url: commands[1][0] + "/" + commands[1][1] + "/", success: function(result){
                    $("#response").append("Command line 2 " + result + "<br />");
                    if(numLines > 2){
                        $.ajax({url: commands[2][0] + "/" + commands[2][1] + "/", success: function(result){
                            $("#response").append("Command line 3 " + result + "<br />");
                            if(numLines > 3){
                                $.ajax({url: commands[3][0] + "/" + commands[3][1] + "/", success: function(result){
                                    $("#response").append("Command line 4 " + result + "<br />");
                                }
                            })
                            .fail(function() {
                                $("#response").append("No response from rover<br />");
                            });
                        }
                    }
                })
                .fail(function() {
                    $("#response").append("No response from rover<br />");
                });
            }
        }
    })
    .fail(function() {
        $("#response").append("No response from rover<br />");
    });
}
}
})
.fail(function() {
    $("#response").append("No response from rover<br />");
});
}
}

function isInt(value) {
    return !isNaN(value) && (function(x) { return (x | 0) === x; })(parseFloat(value))
}

</script>

</body>
</html>
